// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Service sessions table for revenue data management
model ServiceSession {
  id               String   @id @default(cuid())
  store_id         String
  beautician_id    String
  service_date     DateTime @db.Date
  gross_revenue    Decimal  @db.Decimal(12, 2)
  payment_method   PaymentMethod

  // Calculated fields derived from business rules
  beautician_share Decimal? @db.Decimal(12, 2)
  subsidy         Decimal? @db.Decimal(12, 2)
  net_revenue     Decimal? @db.Decimal(12, 2)

  // Audit fields
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
  entry_channel   String?  // 'bulk_import', 'manual_entry', 'api'
  exception_flag  Boolean  @default(false)

  @@map("service_sessions")
  @@index([store_id])
  @@index([service_date])
  @@index([beautician_id])
  @@index([store_id, service_date])
}

// Cost entries table for cost data management
model CostEntry {
  id                String   @id @default(cuid())
  store_id          String
  category          String
  payer             String
  amount            Decimal  @db.Decimal(12, 2)
  allocation_rule_id String?

  // Audit fields
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  created_by        String   // UUID of the user who created the entry

  @@map("cost_entries")
  @@index([store_id])
  @@index([category])
  @@index([created_at])
  @@index([store_id, category])
}

// Audit logs table for tracking all data changes
model AuditLog {
  id           String   @id @default(cuid())
  table_name   String
  record_id    String
  action       AuditAction
  old_values   Json?
  new_values   Json?
  changed_by   String   // UUID of the user who made the change
  request_id   String?  // For correlation across operations
  store_id     String   // For store-scoped access
  timestamp    DateTime @default(now())

  @@map("audit_logs")
  @@index([table_name])
  @@index([record_id])
  @@index([changed_by])
  @@index([store_id])
  @@index([timestamp])
  @@index([table_name, record_id])
}

// Audit action enumeration
enum AuditAction {
  CREATE
  UPDATE
  DELETE

  @@map("audit_action")
}

// Payment method enumeration
enum PaymentMethod {
  cash
  transfer
  other

  @@map("payment_method")
}