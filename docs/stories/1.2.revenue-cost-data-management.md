# Story 1.2: Revenue and Cost Data Management

## Status

approved

## Story

**As a** store manager or finance staff,
**I want** to bulk import daily revenue and cost data through templates and edit individual records in the system,
**so that** I can efficiently digitize our current manual financial tracking process and establish the foundation for daily reporting.

## Acceptance Criteria

1. System must support bulk import of daily revenue data via CSV/Excel templates with store, beautician, service date, gross revenue, payment method fields, and allow validation/error reporting during import process. (Epic 1 scope)
2. Cost entry interface must support store, category, payer, and allocation rule dimensions with individual record creation and editing capabilities. (Epic 1 scope)
3. Revenue records must include automatic calculation of beautician share, subsidies, and net revenue based on configurable business rules (4/6 split mentioned in PRD). (Epic 1 scope)
4. System must generate basic daily reports showing revenue totals by store/beautician and cost breakdowns by category. (Epic 1 scope)
5. Initial exception detection must flag records with missing required fields or unusual values (e.g., negative amounts, invalid dates). (Epic 1 scope)
6. All data operations must include proper validation using Zod schemas and maintain audit trails for changes. (Epic 1 scope)

## Tasks / Subtasks

- [x] Create domain models and Zod schemas for revenue and cost data (AC: 1, 2, 3, 6)
  - [x] Define `ServiceSession` model with store_id, beautician_id, service_date, gross_revenue, payment_method fields
  - [x] Define `CostEntry` model with store_id, category, payer, allocation_rule_id fields
  - [x] Create Zod validation schemas for both models in libs/domain
  - [x] Add TypeScript types and export from libs/domain barrel
- [x] Implement Prisma database schema and migrations (AC: 1, 2, 3, 6)
  - [x] Create service_sessions table based on data architecture specifications
  - [x] Create cost_entries table with proper foreign key relationships
  - [x] Add audit_logs table for tracking data changes
  - [x] Create and run initial database migration
- [x] Build backend API endpoints for revenue management (AC: 1, 3, 6)
  - [x] POST /api/v1/revenue/bulk-import endpoint with file upload handling
  - [x] GET /api/v1/revenue/sessions endpoint with pagination and filtering
  - [x] POST /api/v1/revenue/sessions endpoint for single record creation
  - [x] PUT /api/v1/revenue/sessions/:id endpoint for record updates
  - [x] Implement business rule engine for beautician share calculation (4/6 split)
- [ ] Build backend API endpoints for cost management (AC: 2, 6)
  - [ ] POST /api/v1/costs endpoint for cost entry creation
  - [ ] GET /api/v1/costs endpoint with filtering by store/category
  - [ ] PUT /api/v1/costs/:id endpoint for cost updates
  - [ ] DELETE /api/v1/costs/:id endpoint with soft delete
- [ ] Implement basic exception detection system (AC: 5)
  - [ ] Create validation rules for required fields and data ranges
  - [ ] Flag suspicious records (negative amounts, future dates, etc.)
  - [ ] Store exception records in database with severity levels
- [ ] Build admin web UI for revenue data management (AC: 1, 3)
  - [ ] Create bulk import wizard using 3-step Stepper Form (‰∏ä‰º† ‚Üí È¢ÑËßà ‚Üí ÁªìÊûú)
  - [ ] Implement Upload Dropzone with drag-and-drop support and template download
  - [ ] Build Validation Summary component showing upload validation results
  - [ ] Create KPI Summary Card components for revenue metrics display
  - [ ] Implement Editable Table component with inline editing capabilities
  - [ ] Add Status Tabs for data state classification [ÂÖ®ÈÉ®|üü¢ Ê≠£Â∏∏|‚ö†Ô∏è ÂºÇÂ∏∏|‚úÖ Â∑≤Á°ÆËÆ§]
  - [ ] Apply responsive design (Mobile <768px, Desktop 1024px+, 12-column grid)
  - [ ] Implement UI animations (200ms fast interactions, 300ms transitions)
- [ ] Build admin web UI for cost data management (AC: 2)
  - [ ] Create cost entry form with category and allocation rule selectors
  - [ ] Build cost records table with store/category filtering
  - [ ] Implement cost record edit functionality
- [ ] Create basic daily reporting functionality (AC: 4)
  - [ ] Implement /api/v1/reports/daily endpoint with date range filtering
  - [ ] Create report data aggregation service in backend
  - [ ] Build basic daily report UI showing revenue/cost totals
  - [ ] Add export to Excel functionality for reports
- [ ] Add comprehensive testing (AC: All)
  - [ ] Unit tests for domain models and validation schemas
  - [ ] Integration tests for API endpoints using Supertest
  - [ ] Frontend component tests using React Testing Library
  - [ ] UI/UX testing for responsive design (Mobile <768px, Desktop 1024px+)
  - [ ] Component animation timing validation (200ms interactions, 300ms transitions)
  - [ ] Upload dropzone drag-and-drop functionality testing
  - [ ] Stepper form navigation and validation flow testing
  - [ ] E2E tests for bulk import and reporting workflows using Playwright

## Dev Notes

### Previous Story Insights

From Story 1.1 completion:

- Nx monorepo is fully established with all apps and libs scaffolded
- TypeScript path mappings are configured (@beauty-shop/domain, @beauty-shop/ui, etc.)
- Docker development environment is ready with PostgreSQL and Redis
- ESLint security plugin active with comprehensive rules
- All baseline infrastructure is in place for feature development

### Data Models

Based on data architecture specifications [Source: docs/architecture/data-architecture.md#core-entities]:

**ServiceSession Model:**

- Core fields: id (UUID), store_id (UUID FK), beautician_id (UUID FK), service_date (DATE), gross_revenue (NUMERIC), payment_method (ENUM)
- Calculated fields: beautician_share, subsidy, net_revenue (derived from business rules)
- Audit fields: created_at, updated_at, entry_channel, exception_flag
- Database table: `service_sessions` with indexes on store_id, service_date, beautician_id

**CostEntry Model:**

- Core fields: id (UUID), store_id (UUID FK), category (TEXT), payer (TEXT), amount (NUMERIC), allocation_rule_id (UUID)
- Audit fields: created_at, updated_at, created_by (UUID FK)
- Database table: `cost_entries` with indexes on store_id, category, created_at

**Validation Requirements:**

- All monetary amounts must be positive NUMERIC(12,2)
- Service dates must not be in the future
- Payment methods restricted to: 'cash', 'transfer', 'other'
- Store_id and beautician_id must reference existing records

### API Specifications

RESTful endpoints following backend architecture [Source: docs/architecture/backend-architecture.md#api-layer]:

**Revenue Endpoints:**

- POST /api/v1/revenue/bulk-import - multipart/form-data for CSV/Excel upload
- GET /api/v1/revenue/sessions?store_id=&date_from=&date_to=&limit=50&cursor= - paginated listing
- POST /api/v1/revenue/sessions - create single session record
- PUT /api/v1/revenue/sessions/:id - update existing session

**Cost Endpoints:**

- POST /api/v1/costs - create cost entry
- GET /api/v1/costs?store_id=&category=&limit=50 - filtered listing
- PUT /api/v1/costs/:id - update cost entry
- DELETE /api/v1/costs/:id - soft delete

**Reporting Endpoints:**

- GET /api/v1/reports/daily?store_id=&date_from=&date_to= - daily aggregated data

All endpoints require JWT authentication and store-scope authorization [Source: docs/architecture/backend-architecture.md#service-breakdown].

### Component Specifications

Frontend components using Vite + React 19 + shadcn/ui [Source: docs/architecture/frontend-architecture.md#admin-web-vite-react]:

### UI Design Specifications

Âü∫‰∫é UI ËÆæËÆ°ËßÑËåÉ [Source: docs/ui-design/ascii-layouts.md#Êó•ÁªàÊî∂ÂÖ•ÂΩïÂÖ•]:

**Design System:**

- È¢úËâ≤Á≥ªÁªü: primary #14b8a6, success #10b981, warning #f59e0b, danger #ef4444
- Â≠ó‰ΩìËßÑËåÉ: H1 24px/600, H2 20px/600, Body 14px/400
- Èó¥Ë∑ùÁ≥ªÁªü: Âü∫Á°ÄÊ≠•Èïø 4pxÔºåÂ∏∏Áî®Èó¥Ë∑ù 4/8/12/16/24/32px
- ÂìçÂ∫îÂºèÊñ≠ÁÇπ: Mobile <768px, Tablet 768-1023px, Desktop 1024-1439px

**Bulk Import Wizard (3-Step Stepper):**

```
Ê≠•È™§1: ‰∏ä‰º†Âå∫ ‚Üí Ê≠•È™§2: È¢ÑËßàÂå∫ ‚Üí Ê≠•È™§3: ÁªìÊûúÈ°µ
‚ë† ‰∏ä‰º† ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ ‚ë° È¢ÑËßà ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ ‚ë¢ ÁªìÊûú
```

- Upload Dropzone: ÊîØÊåÅÊãñÊãΩ Excel/CSV Êñá‰ª∂ÔºåÂåÖÂê´[ÈÄâÊã©Êñá‰ª∂] [üì• ‰∏ãËΩΩÊ®°Êùø]ÊåâÈíÆ
- Validation Summary: ‚úÖ Â≠óÊÆµÊ†ºÂºèÊ£ÄÊü•ÈÄöËøá / ‚ö†Ô∏è ÂèëÁé∞ 3 Êù°ÂºÇÂ∏∏Êï∞ÊçÆÈúÄË¶ÅÁ°ÆËÆ§
- Progress Tracking: ÊòæÁ§∫È™åËØÅËøõÂ∫¶ÂíåÂØºÂÖ•Áä∂ÊÄÅ

**Editable Data Table:**

- ÊîØÊåÅ inline ÁºñËæëÁöÑÊî∂ÂÖ•ËÆ∞ÂΩïË°®Ê†º
- ÂàóÁªìÊûÑ: [‚òë] | Êó•Êúü | Èó®Â∫ó | ÊúçÂä°È°πÁõÆ | ÈáëÈ¢ù | ÁæéÂÆπÂ∏à | Áä∂ÊÄÅ
- ÊâπÈáèÊìç‰Ωú: [ÊâπÈáèÊìç‰Ωú ‚ñº] ‰∏ãÊãâËèúÂçï
- Áä∂ÊÄÅÊåáÁ§∫: ‚úÖ Ê≠£Â∏∏ ‚ö†Ô∏è ÂºÇÂ∏∏ Áä∂ÊÄÅÊ†áËØÜ

**KPI Summary Cards:**

- ‰ªäÊó•ÂáÄÊî∂ÂÖ•Âç°Áâá: ÊòæÁ§∫ÈáëÈ¢ùÂíåÂêåÊØîÂ¢ûÈïø ‚Üë12.5%
- Êú™‰∫§Êé•Áé∞ÈáëÂç°Áâá: ÊòæÁ§∫ÈáëÈ¢ùÂíåÊâπÊ¨°Êï∞Èáè
- ÂºÇÂ∏∏ÂæÖÂ§ÑÁêÜÂç°Áâá: ÊòæÁ§∫ÂºÇÂ∏∏È°πÁõÆÊï∞Èáè

**Animation Specifications:**

- Âø´ÈÄü‰∫§‰∫í: 200ms (ÊåâÈíÆÁÇπÂáª„ÄÅÁä∂ÊÄÅÂàáÊç¢)
- ‰∏ÄËà¨ËøáÊ∏°: 300ms (È°µÈù¢ÂàáÊç¢„ÄÅË°®ÂçïÂ±ïÂºÄ)
- ÁºìÂä®ÂáΩÊï∞: cubic-bezier(0.4, 0, 0.2, 1)

**Form Components:**

- Revenue session form with store/beautician selectors
- Cost entry form with category dropdown and amount validation
- Date pickers using shadcn/ui Calendar components
- All forms validated with Zod schemas from libs/domain

### File Locations

Based on project structure [Source: docs/architecture/source-tree.md#monorepo-organization]:

**Backend (NestJS):**

- `apps/api-gateway/src/modules/revenue/` - Revenue service module
- `apps/api-gateway/src/modules/costs/` - Cost management module
- `apps/api-gateway/src/modules/reports/` - Reporting module
- `scripts/db-migrations/prisma/schema.prisma` - Database schema
- `scripts/db-migrations/prisma/migrations/` - Migration files

**Frontend (React):**

- `apps/admin-web/src/pages/revenue/` - Revenue management pages
- `apps/admin-web/src/pages/costs/` - Cost management pages
- `apps/admin-web/src/pages/reports/` - Basic reporting pages
- `apps/admin-web/src/components/` - Local UI components

**UI Components (shadcn/ui based):**

- `apps/admin-web/src/components/ui/stepper-form.tsx` - 3-step import wizard
- `apps/admin-web/src/components/ui/editable-table.tsx` - Inline editing table
- `apps/admin-web/src/components/ui/kpi-summary-card.tsx` - Metrics display cards
- `apps/admin-web/src/components/ui/upload-dropzone.tsx` - File upload component
- `apps/admin-web/src/components/ui/validation-summary.tsx` - Upload validation display
- `apps/admin-web/src/components/ui/status-tabs.tsx` - Data state classification tabs
- `apps/admin-web/src/styles/design-system.css` - Design system variables

**Shared Libraries:**

- `libs/domain/src/models/` - Domain models and business logic
- `libs/domain/src/schemas/` - Zod validation schemas
- `libs/data-access/src/api/` - API client methods
- `libs/data-access/src/hooks/` - React Query hooks

### Testing Requirements

Based on testing strategy [Source: docs/architecture/testing-quality-strategy.md]:

**Unit Tests:**

- Jest for backend modules testing business logic
- React Testing Library for component testing
- Zod schema tests for data validation contracts
- Minimum 80% coverage target [Source: docs/architecture/coding-standards.md#testing-standards]

**Integration Tests:**

- Supertest for API endpoints against ephemeral Postgres
- Test fixtures for sample revenue/cost data
- Database transaction rollback for test isolation

**E2E Tests:**

- Playwright for complete bulk import workflow
- Test file upload, validation, and record creation flow
- Report generation and export functionality testing

**Test File Locations:**

- Unit tests: next to source files with `.spec.ts` suffix
- Integration tests: `apps/api-gateway/test/` directory
- E2E tests: `apps/admin-web/src/test/e2e/` directory

### Technical Constraints

**Performance Requirements:**

- Bulk import processing time ‚â§ 30 seconds for 1000 records
- Report generation time ‚â§ 3 seconds [Source: docs/prd.md#success-metrics--monitoring]
- Single record operations ‚â§ 1 second response time

**Security Requirements:**

- All endpoints protected with JWT authentication [Source: docs/architecture/coding-standards.md#authorization]
- Store-scope authorization ensuring users only access their store data
- Input validation using Zod schemas to prevent injection attacks
- Audit logging for all data modification operations

**Technology Constraints:**

- Node.js 20 LTS runtime [Source: docs/architecture/tech-stack.md#backend-stack]
- PostgreSQL 15 with Prisma ORM [Source: docs/architecture/tech-stack.md#database--storage]
- React 19 with TypeScript strict mode [Source: docs/architecture/tech-stack.md#frontend-stack]

### Project Structure Notes

Perfect alignment with established Nx monorepo structure:

- All new modules follow existing patterns in apps/ and libs/
- TypeScript path aliases already configured for cross-library imports
- Database migrations use existing Prisma setup in scripts/
- API endpoints follow RESTful conventions under /api/v1/ prefix

### Dependencies & Follow-ups

- Story 1.3 will extend this foundation with cash handover batch management
- Story 1.4 will add advanced exception detection and partner profit calculations
- Future stories will build mobile app interfaces for beautician self-service

## Testing

- `npm run test` - Run all unit tests
- `npm run lint` - Verify code standards compliance
- `npm run build` - Ensure all applications build successfully
- `docker compose up --build` - Test in containerized environment
- Manual testing of bulk import with sample CSV files
- Verify daily report generation with test data

## Change Log

| Date       | Version | Description                                                         | Author |
| ---------- | ------- | ------------------------------------------------------------------- | ------ |
| 2025-09-26 | 0.1     | Initial draft of Story 1.2                                          | Bob    |
| 2025-09-26 | 0.2     | Added UI design specifications from docs/ui-design/ascii-layouts.md | Sarah  |
| 2025-09-26 | 0.3     | Completed Task 2: Database schema and migrations implementation     | James  |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (claude-sonnet-4-20250514)

### File List

- `apps/api-gateway/prisma/schema.prisma` - Complete Prisma schema with ServiceSession, CostEntry, and AuditLog models
- `apps/api-gateway/prisma/migrations/20250926081239_initial_revenue_cost_schema/migration.sql` - Initial database migration
- `.env` - Updated DATABASE_URL and REDIS_URL with correct credentials
- `apps/api-gateway/src/modules/revenue/revenue.service.ts` - Revenue business logic with 4/6 split calculation
- `apps/api-gateway/src/modules/revenue/revenue.controller.ts` - RESTful API endpoints for revenue management
- `apps/api-gateway/src/modules/revenue/revenue.module.ts` - Revenue module configuration with file upload support
- `apps/api-gateway/src/modules/revenue/csv-parser.service.ts` - CSV/Excel file parsing service for bulk import
- `apps/api-gateway/src/modules/revenue/dto/` - Complete DTO definitions for validation and type safety
- `apps/api-gateway/src/modules/prisma/prisma.service.ts` - Prisma database service with connection management
- `apps/api-gateway/src/modules/prisma/prisma.module.ts` - Global Prisma module
- `apps/api-gateway/src/app/app.module.ts` - Updated to include Revenue and Prisma modules

### Completion Notes

**Task 2: Database Schema & Migrations**

- ‚úÖ Successfully created all three database models (ServiceSession, CostEntry, AuditLog) with proper field types and constraints
- ‚úÖ Implemented all required indexes as specified in the data architecture documentation
- ‚úÖ Created enum types for PaymentMethod (cash, transfer, other) and AuditAction (CREATE, UPDATE, DELETE)
- ‚úÖ Generated and executed initial Prisma migration successfully against PostgreSQL database
- ‚úÖ Verified all table structures and relationships are correctly implemented
- ‚úÖ Updated environment configuration to match docker-compose database credentials

**Task 3: Revenue Management API Endpoints**

- ‚úÖ Implemented complete Revenue API module with proper NestJS architecture
- ‚úÖ Created POST /api/v1/revenue/bulk-import endpoint with CSV/Excel file upload support (10MB limit)
- ‚úÖ Built GET /api/v1/revenue/sessions endpoint with cursor-based pagination and filtering
- ‚úÖ Developed POST /api/v1/revenue/sessions endpoint for individual record creation
- ‚úÖ Implemented PUT /api/v1/revenue/sessions/:id endpoint for record updates
- ‚úÖ Created business rule engine for 4/6 beautician share calculation (60% beautician, 40% store)
- ‚úÖ Added comprehensive data validation with class-validator decorators
- ‚úÖ Built exception detection system (negative amounts, future dates, high values)
- ‚úÖ Implemented proper error handling and logging throughout API layer
- ‚úÖ Created CSV/Excel parser service supporting both file formats with date handling
- ‚úÖ Added Prisma service with connection management and global module configuration

### Debug Log References

No significant debugging issues encountered. Initial authentication error resolved by correcting database credentials in .env file to match docker-compose.yml configuration.
