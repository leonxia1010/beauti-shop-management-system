# 故事 1.1：Monorepo 基线搭建

## 状态

Draft

## 故事

**作为一名** 为 AI 交付团队提供支持的平台工程师，
**我希望** 通过 Nx 建立包含所有主要应用、共享库和自动化脚手架的 monorepo，
**从而** 让后续故事可以专注业务功能，而不必重复构建基础工具。

## 验收标准

1. 使用 Nx 与 npm 建立 monorepo，并生成 `admin-web`、`mobile-app`、`api-gateway`、`batch-jobs` 四个应用，且它们均符合架构文档指定的框架与配置。（Epic 1 范围）
2. 创建 `libs/domain`、`libs/ui`、`libs/data-access`、`libs/auth`、`libs/infra` 五个共享库，配置路径别名、Lint 规则与占位导出，支持跨应用引用。（Epic 1 范围）
3. 在仓库根目录集中配置 ESLint、Prettier、lint-staged，并提供 `npm run lint`、`npm run test`、`npm run build`、`npm run format` 等脚本，确保对所有应用生效。（Epic 1 范围）
4. 提供本地开发环境的 `docker-compose`，可同时启动 NestJS API、PostgreSQL、Redis 以及管理端静态资源服务，满足架构描述的开发拓扑。（Epic 1 范围）
5. 配置 GitHub Actions 流水线，执行依赖安装、Lint、测试以及 Docker 镜像构建，流程与部署计划保持一致。（Epic 1 范围）

## 任务 / 子任务

- [ ] 使用 npm 初始化 Nx Workspace（AC: 1）
  - [ ] 生成符合架构要求的 `admin-web` Vite + React + TypeScript 项目（AC: 1）
  - [ ] 在 Nx 中生成 `mobile-app`（React Native + Expo）项目骨架（AC: 1）
  - [ ] 搭建 `api-gateway`（NestJS REST 服务）与 `batch-jobs`（后台 Worker）项目（AC: 1）
- [ ] 建立共享库与路径别名（AC: 2）
  - [ ] 创建 `libs/domain`、`libs/ui`、`libs/data-access`、`libs/auth`、`libs/infra`，提供 barrel export 与 Nx 项目配置（AC: 2）
  - [ ] 在 tsconfig 中添加到各库的路径映射（AC: 2）
- [ ] 配置根级别 Lint/Format 流程（AC: 3）
  - [ ] 在 `tools/config` 下集中管理 ESLint、Prettier 配置并应用到所有项目（AC: 3）
  - [ ] 通过 lint-staged + Husky（或 npm `prepare`）在提交前执行 `npm run lint` 与 `npm run format`（AC: 3）
- [ ] 提供本地开发编排（AC: 4）
  - [ ] 编写 `docker-compose.yml`，包含 API、Postgres、Redis 与管理端静态资源服务（AC: 4）
  - [ ] 提供 `.env.example`，字段对齐 Secrets Manager 计划中的变量（AC: 4）
- [ ] 建立 CI 流水线（AC: 5）
  - [ ] 创建 GitHub Actions Workflow，执行 lint/test/build 与 Docker 镜像构建/推送（可使用占位密钥）（AC: 5）
  - [ ] 在 README 中添加流水线状态徽章占位符（AC: 5）

## 开发说明（Dev Notes）

### 以往故事洞察

- 这是 Epic 1 的首个故事，暂无前置经验。

### 数据模型

- 本故事仅搭建脚手架，不涉及具体领域数据模型。

### API 规范

- 目前不实现端点；需确保 NestJS 工程结构能支撑后续的领域模块（Auth、Appointments、Revenue 等）。
  [来源: docs/architecture/backend-architecture.md#service-breakdown]

### 组件规范

- 管理后台需采用 Vite + React 18 + TypeScript，并结合 Tailwind 与 shadcn/ui。
  [来源: docs/architecture/frontend-architecture.md#admin-web-vite--react]
- 移动端使用 Expo 管理的 React Native，并与 Web 共享设计 token 和 NativeBase 主题。
  [来源: docs/architecture/frontend-architecture.md#mobile-app-react-native--expo]

### 文件位置

- 严格遵循 monorepo 结构：应用位于 `apps/`、共享逻辑位于 `libs/`、基础设施代码存放于 `infra/`。
  [来源: docs/architecture/high-level-architecture.md#repository-structure]

### 测试要求

- 确保 `npm run test` 可调用 Jest（后端）与 React Testing Library（前端）脚手架；必要时为 Playwright/Detox 留出占位。
  [来源: docs/architecture/testing-quality-strategy.md]

### 技术约束

- 使用 Node 20 工具链；占位代码涉及配置时需遵循 `ConfigService` 模式。
  [来源: docs/architecture/high-level-architecture.md#runtime-component-stack]
- 遵守编码规范：统一 lint、共享逻辑写入 libs、禁止在非配置模块直接访问 `process.env`。
  [来源: docs/architecture/coding-standards-critical.md#coding-standards-critical]

### 安全与运维要点

- `docker-compose` 中的服务应模拟私有子网拓扑，对 Secrets Manager 对应变量给出注释。
  [来源: docs/architecture/architecture-part3.md#deployment--devops]
- CI 流程需与多阶段 Dockerfile 构建策略保持一致，并预留后续推送至 ECR。
  [来源: docs/architecture/architecture-part3.md#deployment--devops]

### 项目结构备注

- Nx target（`build`、`serve`、`test`）命名需与后续自动化保持一致，提前预留 Storybook/MSW 集成挂钩。
  [来源: docs/architecture/high-level-architecture.md#devex--tooling]

### 依赖与后续工作

- 后续故事将在本脚手架上实现领域模型、API 端点与 UI 流程。

## 测试

- `npm run lint`
- `npm run test`
- `npm run build`
- `docker compose up --build`（验证 NestJS API、Postgres、Redis 服务均可启动）

## 变更记录

| 日期       | 版本 | 描述              | 作者 |
| ---------- | ---- | ----------------- | ---- |
| 2025-09-25 | 0.1  | 故事 1.1 初始草稿 | Bob  |
