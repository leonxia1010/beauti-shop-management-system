# Requirements Traceability Matrix

## Story: 1.2 - Revenue and Cost Data Management

### Coverage Summary

- Total Requirements: 6 acceptance criteria
- Fully Covered: 2 (33%)
- Partially Covered: 0 (0%)
- Not Covered: 4 (67%)

### Requirement Mappings

#### AC1: System must support bulk import of daily revenue data via CSV/Excel templates with store, beautician, service date, gross revenue, payment method fields, and allow validation/error reporting during import process

**Coverage: PARTIAL**

Given-When-Then Mappings:

- **Unit Test**: `libs/domain/src/schemas/service-session.schema.spec.ts::bulkImportServiceSessionSchema`

  - Given: Valid string inputs for bulk import (date strings, number strings)
  - When: Schema validation method called
  - Then: Returns parsed data with proper type coercion (Date, Number, Enum)

- **Unit Test**: `libs/domain/src/schemas/service-session.schema.spec.ts::bulkImportServiceSessionSchema`
  - Given: Invalid string inputs (malformed dates, invalid numbers)
  - When: Schema validation method called
  - Then: Returns validation errors with specific field issues

**Coverage Gaps:**

- No integration tests for file upload endpoint (/api/v1/revenue/bulk-import)
- No tests for CSV/Excel file parsing service
- No tests for validation/error reporting during bulk import process
- No E2E tests for complete bulk import workflow

#### AC2: Cost entry interface must support store, category, payer, and allocation rule dimensions with individual record creation and editing capabilities

**Coverage: PARTIAL**

Given-When-Then Mappings:

- **Unit Test**: `libs/domain/src/schemas/cost-entry.schema.spec.ts::costEntrySchema`

  - Given: Valid cost entry data with all required fields
  - When: Schema validation method called
  - Then: Returns validated cost entry object

- **Unit Test**: `libs/domain/src/schemas/cost-entry.schema.spec.ts::createCostEntrySchema`

  - Given: Valid create DTO for cost entry
  - When: Create schema validation called
  - Then: Returns validated DTO for API consumption

- **Unit Test**: `libs/domain/src/schemas/cost-entry.schema.spec.ts::updateCostEntrySchema`
  - Given: Partial update data for existing cost entry
  - When: Update schema validation called
  - Then: Returns validated partial update object

**Coverage Gaps:**

- No integration tests for cost management API endpoints
- No tests for individual record creation/editing workflows
- No frontend component tests for cost entry interface
- No E2E tests for cost record management

#### AC3: Revenue records must include automatic calculation of beautician share, subsidies, and net revenue based on configurable business rules (4/6 split mentioned in PRD)

**Coverage: NONE**

**Coverage Gaps:**

- No unit tests for business rule engine calculations
- No tests verifying 60% beautician / 40% store split calculation
- No tests for subsidy calculation logic
- No tests for net revenue calculation accuracy
- No integration tests for automatic calculation during record creation

#### AC4: System must generate basic daily reports showing revenue totals by store/beautician and cost breakdowns by category

**Coverage: NONE**

**Coverage Gaps:**

- No tests for /api/v1/reports/daily endpoint
- No tests for report data aggregation service
- No tests for revenue totals calculation by store/beautician
- No tests for cost breakdowns by category
- No frontend tests for daily report UI
- No E2E tests for report generation workflow

#### AC5: Initial exception detection must flag records with missing required fields or unusual values (e.g., negative amounts, invalid dates)

**Coverage: PARTIAL**

Given-When-Then Mappings:

- **Unit Test**: `libs/domain/src/schemas/service-session.schema.spec.ts::serviceSessionSchema`

  - Given: Service session with negative gross revenue
  - When: Schema validation called
  - Then: Returns validation error for negative amount

- **Unit Test**: `libs/domain/src/schemas/service-session.schema.spec.ts::serviceSessionSchema`

  - Given: Service session with future service date
  - When: Schema validation called
  - Then: Returns validation error for invalid date

- **Unit Test**: `libs/domain/src/schemas/cost-entry.schema.spec.ts::costEntrySchema`
  - Given: Cost entry with negative or zero amount
  - When: Schema validation called
  - Then: Returns validation error for invalid amount

**Coverage Gaps:**

- No tests for exception detection system implementation
- No tests for flagging suspicious records (high values, etc.)
- No tests for storing exception records in database
- No tests for severity level classification

#### AC6: All data operations must include proper validation using Zod schemas and maintain audit trails for changes

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `libs/domain/src/schemas/service-session.schema.spec.ts`

  - Given: Various valid and invalid service session inputs
  - When: Zod schema validation called
  - Then: Returns proper validation results with detailed error messages

- **Unit Test**: `libs/domain/src/schemas/cost-entry.schema.spec.ts`

  - Given: Various valid and invalid cost entry inputs
  - When: Zod schema validation called
  - Then: Returns proper validation results with field-specific errors

- **Unit Test**: `libs/domain/src/models/service-session.model.spec.ts`
  - Given: PaymentMethod enum values
  - When: Enum accessed
  - Then: Returns correct string values ('cash', 'transfer', 'other')

### Critical Gaps

1. **API Integration Testing**

   - Gap: No integration tests for any API endpoints (revenue, cost, reports)
   - Risk: High - API contracts and business logic untested in realistic scenarios
   - Action: Implement Supertest-based integration tests for all endpoints

2. **Business Logic Verification**

   - Gap: No tests for 4/6 split calculation, subsidy logic, or revenue calculations
   - Risk: High - Core business rules could fail silently in production
   - Action: Add comprehensive unit tests for revenue calculation service

3. **File Upload & Processing**

   - Gap: No tests for CSV/Excel parsing, file upload handling, or bulk import workflow
   - Risk: High - Critical feature completely untested
   - Action: Add integration tests for file upload service and parsing logic

4. **Frontend Component Coverage**

   - Gap: No tests for revenue/cost management UI components
   - Risk: Medium - UI regressions possible during development
   - Action: Implement React Testing Library tests for key components

5. **End-to-End Workflow Testing**

   - Gap: No E2E tests for complete user workflows (bulk import, report generation)
   - Risk: Medium - Integration issues between frontend/backend possible
   - Action: Implement Playwright E2E tests for critical user journeys

6. **Exception Detection System**
   - Gap: Exception detection logic not implemented or tested
   - Risk: Medium - Data quality issues may go undetected
   - Action: Complete exception detection implementation with comprehensive tests

### Test Design Recommendations

Based on gaps identified, recommend:

1. **Integration Test Suite Priority**

   - POST /api/v1/revenue/bulk-import (file upload + validation)
   - GET /api/v1/revenue/sessions (pagination + filtering)
   - POST /api/v1/costs (cost entry creation)
   - GET /api/v1/reports/daily (report generation)

2. **Unit Test Additions Needed**

   - Revenue calculation service (4/6 split logic)
   - CSV/Excel parser service
   - Exception detection rules engine
   - Business rule validation

3. **Frontend Component Tests**

   - Upload Dropzone (drag-and-drop + validation)
   - Editable Table (inline editing)
   - KPI Summary Cards (data display)
   - Stepper Form (3-step wizard workflow)

4. **E2E Test Scenarios**
   - Complete bulk import workflow (upload → validate → confirm)
   - Individual record creation and editing
   - Daily report generation and export
   - Exception handling and resolution

### Risk Assessment

- **High Risk**: AC1, AC3, AC4 - Core features with minimal test coverage
- **Medium Risk**: AC5 - Partial schema validation but missing system implementation
- **Low Risk**: AC6 - Full Zod schema validation coverage

### Quality Gate Impact

Based on this traceability analysis:

- **Critical gaps** in business logic and API integration testing prevent PASS
- **Partial coverage** for data validation provides basic confidence
- **Recommendation**: CONCERNS - Need significant test implementation before production readiness
